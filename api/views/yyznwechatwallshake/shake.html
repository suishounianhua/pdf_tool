<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>请选择您对应的标签</title>
    {{ assets.outputCss() }}

    <style type="text/css">
        .content{
          width: 100%;
          height: 100%;
        }
        img{
          width: 100%;
          height: 100%;
        }
        body{
          background-image: url(https://img.zcool.cn/community/01aa475859f5ada8012060c8c595ad.png@1280w_1l_2o_100sh.png);
          background-size: cover;
        }
        .time{
          color: #f44336;
          font-size: 2rem;
          width: 100%;
          text-align: center;
          position: absolute;
          top: 13%;
        }
        #send{
          width: 100%;
          text-align: center;
          position: absolute;
          top: 75%;
        }
        .score{
          color: #f44336;
          font-size: 2rem;
          width: 100%;
          text-align: center;
          position: absolute;
          top: 7%;
        }
    </style>
</head>
<body onload="init()">
<div class="content">
  <input type="hidden" id="number" value="0"> 
    <div class="time" id="time_detail" style="display:none">
      <span id="time_i">29</span>:
      <span id="time_s">59</span>
    </div>
    
    {% if list['status'] < 1 %}
      <div class="time" id="msg_detail" >
          游戏即将开始
      </div>
    {% elseif list['status'] > 1 %}
      <div class="time" id="msg_detail" >
        游戏结束
      </div>
    {% endif %}
    <div class="score"  style="display:none">
          您当前摇了<span id="score">0</span> 
    </div>
  <a href="javascript:;" class="btn btn-success" id="send" style="display:none"> 模拟摇一摇事件 </a>
</div>

<div class="modal fade" id="loadingModal">
  <div style="width: 200px;height:20px; z-index: 20000; position: absolute; text-align: center; left: 50%; top: 33%;margin-left:-100px;margin-top:-10px">
    <div style="font-size: 10rem;color: #f3f3f3;" id="time_d">
       5
    </div>
    <input type="hidden" id="status" value="{{ list['status'] }}"> 
    <input type="hidden" id="end" value="0"> 
    <h5 style="color:black;color: #c3bcbc;"> <strong>互动即将开始</strong> </h5>
  </div>
</div>
{{ assets.outputJs() }}
<script type="text/javascript">
var SHAKE_THRESHOLD = 3000;
  var last_update = 0;
  var x = y = z = last_x = last_y = last_z = 0;
  var num = 0;
  var isprint = false;
  function init() {
    if (window.DeviceMotionEvent) {
      window.addEventListener('devicemotion', deviceMotionHandler, false);
    } else {
      alert('你当前手机设备并不支持摇一摇');
    }
  }
  function deviceMotionHandler(eventData) {
    var acceleration = eventData.accelerationIncludingGravity;
    var curTime = new Date().getTime();
    if ((curTime - last_update) > 100) {
      var diffTime = curTime - last_update;
      last_update = curTime;
      x = acceleration.x;
      y = acceleration.y;
      z = acceleration.z;
      var speed = Math.abs(x + y + z - last_x - last_y - last_z) / diffTime * 10000;
      var x1 = Math.abs(x-last_x);
      var y1 = Math.abs(y-last_y);
      var z1 = Math.abs(z-last_z);
      var max =0;
      var number = $('#number').val();
      var status = $('#status').val();
      if(x1>y1){
        if(x1>z1){
          max=x1;
        }else{
          max=z1;
        }
      }else {
        if(y1>z1){
          max=y1;
        }else{
          max=z1;
        }
      }
      if(max>40){
        isprint=true;
        if(status < 2){
          number++;
          $('#number').val(number);
        }
      }else if(max<5&&isprint){

        // var node = document.getElementById("ulid");
        // var li=document.createElement("li"); 
        // li.innerText=num;
        // node.appendChild(li);
        // num=0;
        // isprint=false;
      }
      last_x = x;
      last_y = y;
      last_z = z;
    }
  }
  function add(){
    var number = $('#number').val();
    var status = $('#status').val();
    if(status < 2){
      number++;
      $('#number').val(number);
    }
  }

$(function(){
  

  function start(time_d){
    $('#loadingModal').modal({backdrop: 'static', keyboard: false});
    $('#time_d').html(time_d + 1);
    var startInterval = setInterval(function(){
      if(time_d < 1){
        $('#status').val("1");
        clearInterval(startInterval);
        $("#loadingModal").modal('hide');
      }else{
        if(time_d > 0){
          $("#loadingModal").modal('show');
          $('#time_d').html(time_d);
        }
        time_d--;
      }
    },"1000");
  }
  //封装倒计时
  function countdown(times){
    $("#msg_detail").hide();
    $("#time_detail").show();
    var Interval = setInterval(function(){
      if (times > 0) {
        // 分钟
        var minute = "00";
        if (times >= 60) {
          var minutes = Math.floor(times / 60);
          time = times % 60;
          minute = minutes;
          if (minutes < 10) {
            minute = '0' + minutes;
          }
        }else{
          time = times;
        }
        $("#time_i").html(minute);
        if (time < 10) {
          $("#time_s").html("0" + time);
        } else {
          $("#time_s").html(time);
        }
        times--;
      } else {
        // 终止循环
        close_shake();
        clearInterval(Interval);
      }
    },"1000");
  }

  
  
  var status = $('#status').val();//设置变量  0活动未开始，1活动正在开始，2活动已经结束
  if(status < 2){
    if(status > 0){
      var end = "{{ list['detail']['time'] }}";
      open_shake(end);
    }
    //握手
    var status = false;
    var id = "{{ id }}";
    var userid = "{{ userid }}";
    var model = "{{ model }}";
    var url = "{{ url }}";
    // 打开一个 web socket
    var ws = new WebSocket(url);
    ws.onopen = function(){
      // Web Socket 已连接上，使用 send() 方法发送数据
      // ws.send(2);
    };
    ws.onmessage = function (evt){ 
      var received_msg = JSON.parse(evt.data)
      if(received_msg.code == 200){
          //开始累积 
          $("#score").html(received_msg.data.score)
          $(".score").show()
      }else if(received_msg.code == 501){
          //活动尚未开始

      }else if(received_msg.code == 201){
          console.log(received_msg.data.start_num)
          if(received_msg.data.start_num > 0){
              //调取读秒
              start(received_msg.data.start_num );
              open_shake(received_msg.data.end_num);
          }else{
            $('#status').val("1");//开启活动
            open_shake(received_msg.data.end_num);
          }
      }else if(received_msg.code == 502){
        //活动结束
        close_shake();
      }
      console.log("dump");
      console.log(received_msg)
    };
    ws.onclose = function(){ 
      $('#status').val(2);
      console.log("连接断开");
    };
  }else{
    close_shake();
  }

  //终止活动
  function close_shake(){
    $('#status').val(2);
    $("#msg_detail").html("游戏结束");
    $("#msg_detail").show();
    $("#time_detail").hide();
    $("#send").hide();
  }

  function open_shake(time){
    $('#status').val(1);
    // $("#send").show();
    countdown(time);
  }

  var _sendnum = 0;
  var sendInterval = setInterval(function(){
    var status_send = $('#status').val();
    if(status_send < 2 ){
        var number = $('#number').val();
        if(number > 0){
          ws.send(number);
          $('#number').val(0);
        }else{
          if(_sendnum == 3){
            ws.send(0);
            _sendnum = 0;
          }else{
            _sendnum++;
          }
        }
    }else{
      console.log("不再发送消息");
      // 不再发送消息
      clearInterval(sendInterval);
    }
  },500);

  $(document).on("click","#send",function(){
      var number = $('#number').val();
      var status = $('#status').val();
      if(status < 2){
        number++;
        $('#number').val(number);
      }
  });
});
</script>

</body>
</html>