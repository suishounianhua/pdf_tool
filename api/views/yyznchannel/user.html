{% extends "yyznchannel/base.html" %}

{% block title %}
  {{ title }}
{% endblock %}

{% block head %}
	<style type="text/css">
		.message-card.title { text-align: left; margin-bottom: 0; height: auto; }
		h1 { color: #222; font-size: 2.2rem; line-height: 4rem; font-weight: bold; }
		.form-group input { margin-left: 1rem; }
		.invalid-feedback { text-align: left; margin-top: -1rem; text-indent: 3rem; display: none; }
		.invalid-feedback.invalid { display: block; }
		#qrcodeBtn { text-decoration: none; }
		#qrcodeBtn.disabled { color: white; background-color: lightgray; }
		.card-box.cop { margin-top: 1rem; }
		.card-box.cop form { margin: 0 3rem; }
		/*.card-box.cop .btn-login {}*/
	</style>
{% endblock %}
	
{% block content %}
	<div class="background-gary">
		<div class="message-card title">
			<h1>填写信息<br>
			领取裂变宝试用资格</h1>
		</div>
		<div class="card-box cop">
			<form class="form-inline">
				<div class="form-group">
					<i class="fa fa-mobile fa-fw" aria-hidden="true"></i>
					<input type="text" class="form-control" id="mobileTxt" placeholder="请输入手机号码">
				</div>
				<div class="invalid-feedback" id="validMobile"></div>
				<!-- <div class="form-group">
					<i class="fa fa-lock fa-fw" aria-hidden="true"></i>
					<input type="password" class="form-control" id="passwordTxt" placeholder="请输入密码">
				</div>
				<div class="invalid-feedback" id="validPassword"></div> -->
				<div class="form-group code">
					<i class="fa fa-qrcode fa-fw" aria-hidden="true"></i>
					<input type="text" class="form-control" id="codeTxet" placeholder="请输入验证码">
					<a href="JavaScript:;" class="code" id="qrcodeBtn">获取验证码</a>
				</div>
				<div class="invalid-feedback" id="validCode"></div>
				<input type="hidden" id="channelId" value="{{ channel_id }}"/>
				<button type="bottom" class="btn btn-default btn-login" onClick='return false' id="btn-login">提交</button>
			</form>
		</div>
	</div>
	<script type="text/javascript">
		$(function(){
			let isCount = localStorage.getItem('countTime') || 60;
			if(isCount != 60) {
				countTimeNumber(Number(isCount));
			}
			// 手机号 输入框
			$('#mobileTxt').change(function(event) { $('#validMobile').removeClass('invalid'); });
			// 验证码 按钮
			$('#qrcodeBtn').click(function(event) { getCheckCode(); });
			// 提交 按钮
			$('#btn-login').click(function(event) { actionFrom(); });
		});
		// 验证码 倒计时
		function countTimeNumber(_number){
			clearInterval(window.timeCount);
			isCount = _number;
			window.timeCount = setInterval(res=>{
				console.log(isCount);
				isCount --;
				localStorage.setItem('countTime', isCount);
				$('#qrcodeBtn').text(isCount + '秒继续').addClass('disabled');
				if(isCount <= 0){
					localStorage.setItem('countTime', '60');
					$('#qrcodeBtn').text('获取验证码').removeClass('disabled');
					clearInterval(window.timeCount);
				}
			}, 1000);
		}
		// 获取验证码
		function getCheckCode(){
			if($('#qrcodeBtn').hasClass('disabled')){
				return false;
			}
			if($('#mobileTxt').val() == '') {
				return $('#validMobile').addClass('invalid').text('请输入手机号码.');
			}
			if(!(/^1(3|4|5|6|7|8|9)\d{9}$/.test($('#mobileTxt').val()))){
				return $('#validMobile').addClass('invalid').text('请正确手机号码.');	
			}
			$.ajax({
				url: '/new/User/sendVerif',
				type: 'POST',
				dataType: 'JSON',
				data: { 
					mobile: $('#mobileTxt').val()
				},
				success: function(res){
					if(res.code == 200){
						countTimeNumber(Number(60));
					} else {
						$('#validMobile').removeClass('invalid');
						$('#validPassword').removeClass('invalid');
						$('#validCode').addClass('invalid').text(res.info);
					}
				},
				fail: function(res){
					$('#validMobile').removeClass('invalid');
					$('#validPassword').removeClass('invalid');
					$('#validCode').addClass('invalid').text(res.info);
				}
			});
		}
		// 提交 表单
		function actionFrom(){
			if($('#mobileTxt').val() == '') {
				return $('#validMobile').addClass('invalid').text('请输入手机号码.');
			}
			if(!(/^1(3|4|5|6|7|8|9)\d{9}$/.test($('#mobileTxt').val()))){
				return $('#validMobile').addClass('invalid').text('请正确手机号码.');	
			}
			// if($('#passwordTxt').val() == '') {
			// 	return $('#validPassword').addClass('invalid').text('请输入密码.');
			// }
			// if($('#passwordTxt').val() < 6){
			// 	return $('#validPassword').addClass('invalid').text('请输入密码长度不能小于6.');
			// }
			if($('#codeTxet').val() == '') {
				return $('#validCode').addClass('invalid').text('请输入验证码.');
			}
			if($('#codeTxet').val() < 4){
				return $('#validCode').addClass('invalid').text('验证码不能小于4.');	
			}
			$.ajax({
				url: '/new/User/setMobile', // 提交表单 接口路径
				type: 'POST',
				dataType: 'JSON',
				data: { 
					mobile: $('#mobileTxt').val(), // 手机号
					code: $('#codeTxet').val(), // 验证码
					channel_id: $('#channelId').val()//渠道id
				},
				success: function(res){
					if(res.code == 200){
						window.location.href = '/new/yyznchannel/user_submit_ok'
					} else {
						$('#validPassword').removeClass('invalid');
						$('#validCode').removeClass('invalid');
						$('#validMobile').addClass('invalid').text(res.info);
					}
				},
				fail: function(res){
					$('#validPassword').removeClass('invalid');
					$('#validCode').removeClass('invalid');
					$('#validMobile').addClass('invalid').text(res.info);
				}
			});
		}
	</script>
{% endblock %}

{% block footer %}

{% endblock %}