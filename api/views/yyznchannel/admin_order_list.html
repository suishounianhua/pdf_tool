{% extends "yyznchannel/base.html" %}

{% block title %}
  {{ title }}
{% endblock %}

{% block head %}
	<style type="text/css">
		.background-gary.nt { overflow: hidden; }
		.card-list.order li { flex-direction: column; }
		.card-list .content { display: flex; flex-direction: row; }
		.card-list li .desc { line-height: 2.6rem; display: flex; flex-direction: column; }
		.card-list li .desc .time { width: 100%; display: block; }
		.card-list li .desc .attr { display: flex; flex-direction: row; justify-content: space-between; }
		.card-list li .desc .time .item { width: 100%; }
		.card-list li .desc .item { width: 50%; display: inline-block; font-size: 1.35rem; color: #999999; }
		.card-list li .desc .item span { color: #444444; }
		.card-list .count { display: block; width: 100%; border-top: 1px solid #eeeeee; text-align: right; }
		.card-list .money { color: #fc9a6c; line-height: 4.8rem; height: 3rem; font-size: 1.65rem; display: inline-block; }
		#listCard { height: calc(100% - 9.5rem); overflow: auto; }
		#listCard.hide { display: none; }
		.pull-up, .pull-down { position: relative; overflow: hidden; height: 0; max-height: 30px; }
		.pull-up, .pull-down-content { position: absolute; bottom: 0; text-align: center; line-height: 30px; color: #999; width: calc(100% - 3rem); }
		#not { display: none; height: calc(100% - 9.5rem); overflow: auto; }
		#not.show { display: block; }
	</style>
{% endblock %}

{% block content %}
	<div class="background-gary nt">
		<div class="tabs-card">
			<ul id="tab-btns">
				<li data-class="all" {% if time_type=='all' %} class="active" {% endif %}><span>全部</span></li>
				<li data-class="today" {% if time_type=='today' %} class="active" {% endif %}><span>今日</span></li>
				<li data-class="month" {% if time_type=='month' %} class="active" {% endif %}><span>近30日</span></li>
				<input type="hidden" id="time_type" value="{{ time_type }}" />
			</ul>
		</div>
		<div class="message-help"> ——— 共<span>{{ order_total }}</span>笔成交，共计收益<span>{{ totay_price }}</span>元 ——— </div>
		<div class="card-list order" id="listCard">
			<div class="pull-down"> <span class="pull-down-content">松手刷新数据</span> </div>
			<ul id="newlist"> </ul>
			<div class="pull-up"> <span class="pull-up-content">松手加载更多</span> </div>
		</div>
		<div class="card-list" id="not">
			<div class="pull-down"> <span class="pull-down-content">松手刷新数据</span> </div>
			<div class="message-text" id="messageText">
				<img src="https://bdn.135editor.com/files/yyznchannel/notdata.png">
			</div>
			<div class="pull-up"> <span class="pull-up-content">松手加载更多</span> </div>
		</div>
	</div>

	<script type="text/javascript">
		// 分别设置滑动距离，开始位置，结束位置，和模拟数据的定时器
		let disY, startY, endY, timer, t;
		let nextID =0;
		$(function() {
			initData();
			$('#tab-btns li').click(function(event){
				$(this).addClass('active').siblings().removeClass('active');
				$('#time_type').val($(this).data('class'));
				nextID = 0;
				$('#newlist').html('');
				initData();
			});
			// 触摸开始 => 数据列表
			$('#newlist, #messageText').on('touchstart', function(e) {
				startY = e.originalEvent.changedTouches[0].pageY; // 开始时的坐标
			});
			// 移动中 => 数据列表
			$('#newlist, #messageText').on('touchmove', function(e) {
				endY = e.originalEvent.changedTouches[0].pageY;
				disY = endY - startY; // 移动后的坐标减去开始坐标，滑动距离。
				if (disY < 60) {
					$('.pull-down').css({ height: disY + 'px' }); // 父盒子的高度随着滑动距离变化，有最大值。
				} else {
					$('.pull-down').css({ height: 60 + 'px' }); // 父盒子的最大高度 
				}
			});
			// 结束时 => 数据列表
			$('#newlist, #messageText').on('touchend', function(e) {
				clearInterval(timer);
				endY = e.originalEvent.changedTouches[0].pageY;
				disY = endY - startY;
				if (disY >= 30) {
					if (disY > 60) { disY = 60 }
					timer = setInterval(function() {
						disY -= 5;
						if (disY == 30) {
							$('.pull-down').css({ height: 30 + 'px' }); //松手后的返回。
							nextID = 0;
							$('#newlist').html('');
							initData();
							if (disY == 0) {
								clearInterval(timer);
							}
						}
						$('.pull-down').css({ height: disY + 'px' });
					}, 30)
				}
				if (disY <= -30) {
					if (disY < -60) { disY = -60 }
					timer = setInterval(function() {
						disY += 5;
						if (disY == -30) {
							$('.pull-up').css({ height: 30 + 'px' }); //松手后的返回。
							initData()
							if (disY == 0) {
								clearInterval(timer);
							}
						}
						$('.pull-up').css({ height: 30 - disY + 'px' });
					}, 30)
				}
			});
		});
		function initData(){
			$.ajax({
				url: '/new/yyznchannel/admin_order_list',
				type: 'POST',
				dataType: 'json',
				data: {
					time_type: $('#time_type').val(),
					next_id: nextID
				},
				success: function(res){
					if(res.code == 200){
						let resData = res.data;
						let datalist = resData.datalist;
						let total = resData.total;
						nextID = resData.next_id;
						
						$('.message-help').html(' ——— 共<span>' + total +'</span>笔成交，共计收益<span>' + resData.totay_price +'</span>元 ——— ');
						if(total == 0){
							$('#listCard').addClass('hide');
							$('#not').addClass('show');
						} else {
							$('#listCard').removeClass('hide');
							$('#not').removeClass('show');
						}
						if(datalist.length > 0){
							let _target = $('#newlist');
							for (var i = 0; i < datalist.length; i++) {
								_target.append(`<li class="item">
								<div class="content">
									<div class="header">
										<img src="` +(datalist[i].user_headimg==''?'https://bdn.135editor.com/files/202005/yyznchannel/header006.jpg':datalist[i].user_headimg)+ `">
									</div>
									<div class="info">
										<div class="title">` + datalist[i].user_name + `</div>
										<div class="desc">
											<div class="attr">
												<div class="item">成交额: <span>` + datalist[i].total_price + `</span></div>
												<div class="item">成交商品: <span>` + datalist[i].auth_name + `</span></div>
											</div>
											<div class="time">
												<div class="item">成交时间: ` + datalist[i].createtime + `</div>
											</div>
										</div>
									</div>
								</div>
								<div class="count">
									<span class="money">收益: ` + datalist[i].commission_price + `</span>
								</div>
							</li>`);
							}
						}
					}
				}
			});
		}
	</script>
{% endblock %}

{% block footer %}
{% endblock %}